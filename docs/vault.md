## Summary

It is a best practice to secure the configuration items that are of sensitive nature such as database credentials so that they are not intentionally or accidentally exposed to non-authorized actors. The basic setup of the starter-kit only includes the options for specifying externalized config in a file, or command line or as environment variable and does not take care of this aspect.

One of the common recommended approaches is to store such sensitive configuration items in a secure config vault. Applications that have authorized access to the vault and only them can then access these items and their values.

To enable such a secure vault with starter-kit we employ Hashicorp Vault as default. It provides a secure store, ability to store configuration of different applications in one store and access via secure REST api for applications.

## Setup

### 1. Spin up vault server container

#### Via docker compose

```shell
$ make docker-infra-vault
```

#### Or via [devbox](devbox.md)

```shell
$ devbox vault up
```

### 2. Unseal vault

```shell
$ make vault-unseal
```

**Note:** After running the above command, you will find `UNSEAL_KEY`, `ROOT_TOKEN`, `ROLE_ID`, `SECRET_ID` in the console output. Please take a note of these values.

### 3. Export secrets and push them to vault server

- Export the required secrets as environment variables.
- Modify the `tools/demo/vault/add-secrets.sh` file with the secrets you are exporting.
- For demo, lets add `DB_PASSWORD` and `KEY` to vault server.
- Then run the following command to push the secrets to vault.

```shell
$ export DB_PASSWORD=<your-postgres-db-password>
$ export KEY=<your-16-characters-key>
$ export VAULT_TOKEN=<your-vault-root-token> # generated by `make vault-unseal`
$ make vault-add-secrets
```

- In case the `tools/demo/vault/add-secrets.sh` script throws errors, it means that the vault is already initialized and the unseal keys are generated.  
  If you have not noted down the keys, follow the below steps:

```shell
// bring down the vault docker container and delete vault volume
$ make docker-infra-vault CMD="down"
$ docker volume rm dev-setup_vault-vol

// If using devbox, follow the follow steps:
$ devbox vault down
$ devbox vault clean
```

### 4. Steps to view secrets in vault

- Follow these steps first time or any time later to view and update vault configuration.
- Browse to http://localhost:8200 or https://vault.my.devbox/ if using devbox.
- If the page is displaying "vault is sealed", enter the 'unseal key' copied from console output as mentioned above and click 'unseal' (this step may get skipped if already the vault is unsealed by `make vault-unseal` command).
- In the next screen select 'method' as 'Token' and enter the `ROOT_TOKEN` copied from console output as mentioned above
- You will reach the 'Secret Engines screen' and will see two engines listed
- Click and browse into secret/paymentservice/ - you can see the all the secret key/value pairs here.

### 5. Enable vault usage in service

Enable vault in `.env` file

```
VAULT_ENABLED=true
```

In terminal, export ROLE_ID and SECRET_ID. These will be picked up via .env file and used to access the vault server.

```bash
export ROLE_ID=<copied from configuration step>
export SECRET_ID=<copied from configuration step>
```

Remove secrets which were added to vault server from `.env` file. In our demo case, they are `DB_PASSWORD` and `KEY`.

### 6. Restart the application

```shell
$ cd service-java-starter # run one from below commands
$ make boot-run # to run service locally
$ make docker-app #to run service on docker
```

## Password usage in the starter-kit

The starter-kit externalises sensitive information such as passwords using secrets and environment variables. Please follow the recommended security best practices related to these while implementing your services. Additionally please take measures to ensure usage of strong passwords as per general security practices and specific guidelines as applicable for the solution under development. An indicative list of guidance on passwords is as follows:

```
One or more uppercase  characters
One or more numerical digits
One or more special characters
Minimum length of twelve characters
Disallow any part of the user identifiable information
Disallow dictionary words
Disallow last three passwords
```
